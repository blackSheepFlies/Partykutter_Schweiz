<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Swiss Boarding Pass – Abruf</title>
<style>
  :root{ --accent:#d40000; --label:#222; }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin:0; background:#f6f6f6;}
  header{background:white; padding:14px 18px; border-bottom:1px solid #e5e5e5;}
  header h1{margin:0; font-size:18px}
  main{max-width:980px; margin:18px auto; padding:0 16px 28px; display:grid; gap:16px;}
  .card{background:#fff; border:1px solid #e7e7e7; border-radius:12px; box-shadow:0 1px 2px rgba(0,0,0,.03);}
  .row{display:flex; gap:10px; align-items:center}
  .pad{padding:16px}
  label{font-size:14px; color:var(--label); white-space:nowrap}
  input[type="text"]{flex:1; padding:12px 14px; border:1px solid #ddd; border-radius:10px; font-size:16px}
  button{appearance:none; border:1px solid var(--accent); background:var(--accent); color:#fff; padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer}
  .canvas-wrap{padding:16px; display:flex; justify-content:center; align-items:center}
  canvas{max-width:100%; height:auto; background:#fff; border-radius:10px; border:1px solid #eee}
  .admin{display:none; padding:0 16px 16px}
  .admin .row{margin-top:8px}
  .hint{padding:0 16px 16px; color:#666; font-size:12px}
</style>
</head>
<body>
<header><h1>Swiss Boarding Pass – Name eintragen & herunterladen</h1></header>

<main>
  <!-- Public: nur Name + Download -->
  <section class="card pad">
    <div class="row">
      <label for="name">Passenger Name:</label>
      <input id="name" type="text" placeholder="z.B. Pilot Minion" />
      <button id="download">Get your Boarding Pass</button>
    </div>
  </section>

  <!-- Admin-Feintuning (nur sichtbar bei ?admin=1) -->
  <section id="admin" class="card admin">
    <div class="row"><label for="size">Schriftgröße</label><input id="size" type="range" min="18" max="60" value="28"></div>
    <div class="row"><label for="x">X-Position</label><input id="x" type="range" min="0" max="1600" value="120"></div>
    <div class="row"><label for="y">Y-Position</label><input id="y" type="range" min="0" max="900" value="205"></div>
    <div class="row"><label for="width">Max Breite</label><input id="width" type="range" min="200" max="1400" value="680"></div>
    <div class="row"><label for="letter">Buchstabenabstand</label><input id="letter" type="range" min="0" max="4" step="0.1" value="0"></div>
    <p class="hint">Admin-Modus – Werte einmal einstellen, dann URL ohne <code>?admin=1</code> an Gäste geben.</p>
  </section>

  <section class="card canvas-wrap">
    <canvas id="c" width="1536" height="1024" aria-label="Ticket Vorschau"></canvas>
  </section>
  <p class="hint">Falls das Ticket-Bild nicht erscheint: Lade <b>ticket_base.png</b> (dein Boardingpass ohne Namen) ins Repo.</p>
</main>

<script>
(() => {
  // === Einstellungen ===
  const BASE_IMAGE_URL = 'ticket_base.png';      // Ticket ohne Namen (PNG)
  let POS = { size:28, x:120, y:205, width:680, letter:0 }; // Standardwerte
  const FONT_FAMILY = "'Helvetica Neue', Helvetica, Arial, system-ui, sans-serif";
  const FONT_WEIGHT = 700;
  const TEXT_COLOR = "#111";
  const STROKE = {show:true, width:4, color:"#ffffff"};     // dünne weiße Kontur
  const UPPERCASE = false;

  // Admin-Modus via ?admin=1
  const params = new URLSearchParams(location.search);
  const isAdmin = params.get('admin') === '1';
  if (isAdmin) document.getElementById('admin').style.display = 'block';

  const els = {
    name: document.getElementById('name'),
    download: document.getElementById('download'),
    canvas: document.getElementById('c'),
    size: document.getElementById('size'),
    x: document.getElementById('x'),
    y: document.getElementById('y'),
    width: document.getElementById('width'),
    letter: document.getElementById('letter')
  };
  const ctx = els.canvas.getContext('2d');

  // Admin-Slider an POS binden
  ['size','x','y','width','letter'].forEach(k=>{
    if(!els[k]) return;
    els[k].addEventListener('input', ()=>{ POS[k] = +els[k].value; draw(); });
    POS[k] = +els[k].value;
  });

  const img = new Image();
  img.src = BASE_IMAGE_URL + '?v=' + Date.now();  // Cache busting beim ersten Laden
  img.onload = draw;
  img.onerror = () => {
    ctx.fillStyle = "#fff"; ctx.fillRect(0,0,els.canvas.width,els.canvas.height);
    ctx.fillStyle = "#c00"; ctx.font = "20px " + FONT_FAMILY;
    ctx.fillText("ticket_base.png nicht gefunden – lade dein Ticketbild hoch.", 24, 40);
  };

  function applyFont(px){ ctx.font = `${FONT_WEIGHT} ${px}px ${FONT_FAMILY}`; ctx.fillStyle = TEXT_COLOR; ctx.textBaseline = "alphabetic"; }

  function drawSpacedLine(str, x, y, letterSpacing){
    let cx = x;
    for (let i=0;i<str.length;i++){
      const ch = str[i];
      if (STROKE.show){ ctx.lineWidth = STROKE.width; ctx.strokeStyle = STROKE.color; ctx.strokeText(ch, cx, y); }
      ctx.fillText(ch, cx, y);
      cx += ctx.measureText(ch).width + (i<str.length-1 ? letterSpacing : 0);
    }
  }
  function wrapAndDraw(text, x, y, maxWidth, lh, letterSpacing){
    const words = text.split(/\s+/); let line = ''; let cy = y;
    const mw = s => { let w=0; for (let i=0;i<s.length;i++){ w+=ctx.measureText(s[i]).width; if(i<s.length-1) w+=letterSpacing; } return w; };
    for (let n=0;n<words.length;n++){
      const test = (line? line+' ' : '') + words[n];
      if (mw(test) > maxWidth && n>0){ drawSpacedLine(line, x, cy, letterSpacing); line = words[n]; cy += lh; }
      else { line = test; }
    }
    drawSpacedLine(line, x, cy, letterSpacing);
  }

  function draw(){
    ctx.clearRect(0,0,els.canvas.width,els.canvas.height);
    ctx.drawImage(img, 0, 0, els.canvas.width, els.canvas.height);
    let name = (els.name.value || '').trim();
    if (UPPERCASE) name = name.toUpperCase();
    if (!name) return;
    applyFont(POS.size);
    wrapAndDraw(name, POS.x, POS.y, POS.width, Math.round(POS.size*1.25), POS.letter);
  }

  els.name.addEventListener('input', draw);
  els.download.addEventListener('click', ()=>{
    draw();
    const a = document.createElement('a');
    const clean = (els.name.value || 'Passenger').replace(/[^\w\-äöüÄÖÜß ]+/g,'').trim().replace(/\s+/g,'_');
    a.download = `BoardingPass_${clean}.png`;
    a.href = els.canvas.toDataURL('image/png');
    a.click();
  });

  draw();
})();
</script>
</body>
</html>
